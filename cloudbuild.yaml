options:
  env:
  - COMMIT_SHA=$COMMIT_SHA
  - GIT_ORIGIN_URL=https://github.com/m-lab/access.git
  - WORKSPACE_LINK=/go/src/github.com/m-lab/access

  secretEnv:
  - COVERALLS_TOKEN

steps:
- name: gcr.io/$PROJECT_ID/golang-cbif
  args:
  - go get github.com/mattn/goveralls
  - go get -v -t ./...
  - go vet ./...
  - go test ./... -race
  - go test ./... -cover=1 -coverprofile=_c.cov
  - goveralls -jobid=$SHORT_SHA -coverprofile=_c.cov

secrets:
# TODO: change so keys will work for builds outside mlab-sandbox.
- kmsKeyName: projects/mlab-sandbox/locations/global/keyRings/cloud-build-coveralls-tokens/cryptoKeys/access
  secretEnv:
    COVERALLS_TOKEN: CiQA7U54+vf6w10gx27ybhW2B+LsghNQLEM5h5zSuc8L2SBT6w0SSgC1lkIU+HIEhoMwun+X/gqjahpLq0LD38FxsGqAACJ/mv34/J2hwtCJ7W9NqieZbsb1qBOaUmI7TG9uCaHtY2j5nj6vOAJ7ERay
